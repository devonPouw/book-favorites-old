<h1>Search books by criteria</h1>
<form [formGroup]="searchForm" (ngSubmit)="searchTrigger$.next()">
  <div>
    <button
      class="reset-fields-button"
      type="button"
      mat-button
      (click)="clearForm()"
    >
      Reset fields
    </button>
  </div>
  <div class="search-fields">
    <mat-form-field appearance="outline">
      <mat-label
        >Book title
        <mat-icon
          (click)="titleTooltip.show()"
          #titleTooltip="matTooltip"
          matTooltip="
              Will find any books with '{{ title?.value }}' in the title
            "
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input formControlName="title" matInput placeholder="Lord of the Rings" />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('title')!"
      ></bf-clear-form-field>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label
        >Author
        <mat-icon
          (click)="authorTooltip.show()"
          #authorTooltip="matTooltip"
          matTooltip="Will find any books written by '{{ author?.value }}'
            (multiple allowed, separated by spaces or commas)"
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input formControlName="author" matInput placeholder="Roald Dahl" />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('author')!"
      ></bf-clear-form-field>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label
        >ISBN
        <mat-icon
          (click)="isbnTooltip.show()"
          #isbnTooltip="matTooltip"
          matTooltip="
             10-digit and 13-digit ISBNs are allowed
          "
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input
        formControlName="isbn"
        matInput
        #input
        maxlength="13"
        placeholder="1234567890"
        bfIsbnValidator
      />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('isbn')!"
      ></bf-clear-form-field>
      <mat-hint
        >@if(isSearchButtonDisabled() && isbn){
        <span>ISBN is invalid</span>
        @if(isbn.value && isbn.value.length < 10) { {{ isbn.value.length }}/10 }
        @else{ {{ isbn.value?.length }}/13 }}
      </mat-hint>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label
        >Publish year
        <mat-icon
          (click)="publishYearTooltip.show()"
          #publishYearTooltip="matTooltip"
          matTooltip="
           Will find any book published in the year '{{ publishYear?.value }}'.
           For range search, use e.g '2000-2010' or '*-2010 for anything published before and up to the year 2010'
        "
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input formControlName="publishYear" matInput placeholder="2024" />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('publishYear')!"
      ></bf-clear-form-field>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label
        >Language
        <mat-icon
          (click)="languageTooltip.show()"
          #languageTooltip="matTooltip"
          matTooltip="
          enter the first three letters of the language. japan uses 'jpn'. 'mul'
          for multiple and 'und' for undetermined
        "
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input
        formControlName="language"
        maxlength="3"
        matInput
        placeholder="eng"
      />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('language')!"
      ></bf-clear-form-field>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label
        >Place
        <mat-icon
          (click)="placeTooltip.show()"
          #placeTooltip="matTooltip"
          matTooltip="Will find any books about '{{ place?.value }}'
          (multiple allowed, separated by spaces or commas)"
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input formControlName="place" matInput placeholder="Utrecht" />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('place')!"
      ></bf-clear-form-field>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label
        >Subject
        <mat-icon
          (click)="subjectTooltip.show()"
          #subjectTooltip="matTooltip"
          matTooltip="Will find any books about '{{ subject?.value }}'
          (multiple allowed, separated by spaces or commas)"
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input formControlName="subject" matInput placeholder="Fantasy" />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('subject')!"
      ></bf-clear-form-field>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label
        >Publisher
        <mat-icon
          (click)="publisherTooltip.show()"
          #publisherTooltip="matTooltip"
          matTooltip=" Will find any books by a publisher with '{{
            publisher?.value
          }}' in their name"
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input formControlName="publisher" matInput placeholder="Malmberg" />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('publisher')!"
      ></bf-clear-form-field>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label
        >Character
        <mat-icon
          (click)="personTooltip.show()"
          #personTooltip="matTooltip"
          matTooltip="Will find any books with '{{ person?.value }}' in it
        (multiple allowed, separated by spaces or commas)"
          matTooltipPosition="above"
          fontIcon="info"
      /></mat-label>
      <input formControlName="person" matInput placeholder="Harry Potter" />
      <bf-clear-form-field
        matSuffix
        [control]="searchForm.get('person')!"
      ></bf-clear-form-field>
    </mat-form-field>
  </div>

  <div
    style="width: fit-content"
    matTooltip="Filled fields need to be valid."
    [matTooltipDisabled]="!isSearchButtonDisabled()"
  >
    <button type="submit" mat-flat-button [disabled]="isSearchButtonDisabled()">
      Search
    </button>
  </div>
</form>

<div #listContainer class="example-container mat-elevation-z8">
  @if (isLoading() ) {
  <div class="example-loading-shade">
    @if (isLoading()) {
    <mat-spinner></mat-spinner>
    }
  </div>

  }
  <div class="example-table-container">
    <table mat-table [dataSource]="books" class="example-table" matSort>
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef>Title</th>
        <td mat-cell *matCellDef="let row">
          <div *ngIf="row.title">{{ row.title }}</div>
        </td>
      </ng-container>
      <ng-container matColumnDef="rating">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Rating</th>
        <td mat-cell *matCellDef="let row">
          @if(row.ratings_average){
          <div style="display: flex; flex-direction: row">
            @for (item of getStarsArray(row.ratings_average); track $index) {
            <ng-container style="width: 30px">
              <img
                style="height: 24px; width: 24px"
                src="star.svg"
                alt="Star Rating"
                [class.half]="
                  $index === parseRating(row.ratings_average) &&
                  row.ratings_average % 1 >= 0.5
                "
              />
            </ng-container>
            }
            <p style="width: 40px">
              {{ row.ratings_average.toString().slice(0, 3) }}
            </p>
            <p>({{ row.ratings_count }} reviews)</p>
          </div>
          }
        </td>
      </ng-container>
      <ng-container matColumnDef="first_publish_year">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          First published
        </th>
        <td mat-cell *matCellDef="let row">
          <div *ngIf="row.first_publish_year">{{ row.first_publish_year }}</div>
        </td>
      </ng-container>
      <ng-container matColumnDef="ebook_access">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Ebook access</th>
        <td mat-cell *matCellDef="let row">
          <div *ngIf="row.ebook_count_i">{{ row.ebook_count_i }}</div>
        </td>
      </ng-container>
      <ng-container matColumnDef="ddc_sort">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>DDC</th>
        <td mat-cell *matCellDef="let row">
          <div *ngIf="row.ddc">{{ row.ddc[0] }}</div>
        </td>
      </ng-container>
      <ng-container matColumnDef="lcc_sort">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>LCC</th>
        <td mat-cell *matCellDef="let row">
          <div *ngIf="row.lcc">{{ row.lcc[0] }}</div>
        </td>
      </ng-container>
      <ng-container matColumnDef="more">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">
          <a mat-button [routerLink]="'.' + row.key.substring(6)">More info</a>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="4">No books found matching the filter</td>
      </tr>
    </table>
  </div>

  <mat-paginator
    #paginator
    class="demo-paginator"
    (page)="handlePageEvent($event)"
    [length]="resultsLength"
    [pageSize]="limit"
    [showFirstLastButtons]="true"
    [pageSizeOptions]="pageSizeOptions"
    [pageIndex]="page() - 1"
    aria-label="Select page"
  >
  </mat-paginator>
</div>
